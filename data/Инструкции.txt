Установка и настройка SSH на сервере с Ubuntu

Secure Shell (SSH) — это незаменимый протокол для администрирования Linux-серверов, с помощью которого можно создавать защищенный канал связи между вашим компьютером и удаленной машиной. Через этот зашифрованный туннель вы можете выполнять команды, передавать файлы и полностью контролировать сервер, как если бы работали за его физической консолью. Сегодня мы подробно рассмотрим, как настроить SSH-сервер на дистрибутиве Ubuntu 24.04, как подключиться к серверу, а также рассмотрим основные параметры настройки SSH-сервера.
Предварительные требования
Для работы нам понадобятся:
Облачный сервер с любым дистрибутивом Linux. Мы будем использовать Ubuntu 24.04.
Домашний или рабочий компьютер/ноутбук с любой ОС — Windows, macOS, Linux, с которого мы будем производить SSH-подключение к нашему серверу.
Как работает протокол SSH
Основная задача SSH — защитить данные от перехвата. При установке соединения (по умолчанию через TCP-порт 22) происходит следующее:
«Рукопожатие» (Handshake): Клиент и сервер договариваются о параметрах шифрования с помощью асимметричной криптографии. Это позволяет безопасно сгенерировать общий секретный ключ, даже если канал связи изначально не защищён.
Защита трафика: После установления доверия весь дальнейший обмен данными шифруется симметричными алгоритмами, что обеспечивает высокую скорость и надёжность. Такой подход гарантирует конфиденциальность информации и защищает от атак «человек посередине» (MITM).
Особенности работы с SSH в Timeweb Cloud
При развертывании сервера в Timeweb Cloud SSH-сервер уже предустановлен и активирован по умолчанию. В процессе создания машины вам предложат два варианта авторизации:
По паролю: Будет создана стандартная учетная запись root с паролем, который можно найти в панели управления (раздел «Дашборд»). Это самый простой, но не самый безопасный способ.
По SSH-ключу: Более предпочтительный и безопасный метод. Потребуется заранее сгенерировать криптографические ключи на своем компьютере и загрузить открытую часть в панель Timeweb Cloud перед запуском сервера.
Если разрешить доступ по паролю, то для подключения достаточно использовать имя пользователя и пароль, которые будут доступны после запуска сервера в разделе «Дашборд»:
Работа от имени суперпользователя (root) несет риски. Далее мы рассмотрим, как создать непривилегированного пользователя и отключить прямой вход для root.
Создание SSH-ключей
Аутентификация по ключам значительно надежнее, так как исключает риск подбора или утечки пароля. Чтобы использовать ключи для подключения, сначала их нужно сгенерировать. Это можно сделать с помощью команды ssh-keygen.
Команду для генерации ключей необходимо выполнять на своем компьютере (не на сервере). 
Откройте терминал (или PowerShell в Windows) и выполните:
ssh-keygen
Программа предложит указать путь для сохранения (нажмите клавишу Enter для выбора стандартного пути). Также при необходимости можно придумать парольную фразу (passphrase) для дополнительной защиты приватного ключа. В рамках данной статьи мы не будем указывать парольную фразу, поэтому просто нажмем на клавишу Enter.
Команда генерирует 2 файла:
Открытый (публичный) ключ — его можно свободно копировать, перемещать и размещать на удаленных серверах, к которым необходимо подключиться.
Закрытый (приватный) ключ — секретная часть, которую нельзя никому передавать и копировать. Аналогичен физическому ключу от замка и должен храниться только на том устройстве, где он был сгенерирован.
Далее разместим публичный ключ на сервере, к которому мы хотим подключаться. По умолчанию ключи сохраняются на вашем устройстве в скрытой папке .ssh в домашней директории пользователя:
Windows: C:\Users\<имя_пользователя>\.ssh
macOS: /Users/<имя_пользователя>/.ssh
Linux: /home/<имя_пользователя>/.ssh
Перейдите в эту директорию и найдите публичный ключ — файл с расширением .pub. Откройте его, например, с помощью блокнота и скопируйте содержимое.
Далее на этапе создания сервера в панели Timeweb Cloud нажмите на кнопку «Загрузить новый ключ»:
Image1
В открывшемся окне вставьте скопированное содержимое публичного ключа и нажмите на кнопку «Добавить»:
Image7
В процессе подключения при помощи ключей пароль вводить не надо.
Подключение по протоколу SSH
Подключиться по протоколу SSH можно из любой операционной системы при помощи консольного клиента ssh.
Процесс подключения происходит следующим образом:
Откройте командную строку или PowerShell (для Windows) или терминал (для macOS и Linux).
Введите команду для подключения. Она выглядит так:
ssh имя_пользователя@IP_адрес_сервера
При первом подключении мы будем использовать пользователя root:
ssh root@IP_адрес_сервера
Вы можете скопировать готовую команду для подключения в панели Timeweb Cloud, на дашборде вашего сервера.
Если вход осуществляется по паролю, введите пароль пользователя, из-под которого производится подключение. Если же используются SSH-ключи, то пароль вводить не нужно.
Подключение будет установлено.
Помимо терминала и PowerShell, для подключения также можно использовать SSH-клиенты с графическим интерфейсом:
Для Windows: PuTTY, MobaXterm, Xshell, mRemoteNG.
Для macOS: Termius и Tabby.
Для Linux: Remmina и Muon SSH.
Изменение конфигурации SSH
Хотя при заказе Linux-сервера в Timeweb Cloud вы получаете уже готовую конфигурацию SSH, вы также можете дополнительно изменить ее под конкретные задачи, а также усилить защиту. 
Основные параметры настраиваются в файле на вашем сервере, который размещен по пути /etc/ssh/sshd_config. 
После внесения любых изменений необходимо перезагрузить службу SSH. В Ubuntu 24.04 это можно сделать командами:
systemctl daemon-reload && systemctl restart ssh.socket
Отключение пароля для аутентификации
Один из самых важных параметров безопасности SSH — отключение возможности заходить на сервер по паролю после настройки аутентификации по SSH-ключу. Это исключает риск подбора пароля при попытке подключения. 
Перед тем как отключать вход по паролю убедитесь, что аутентификация по ключам успешно работает, иначе есть риск заблокировать самого себя.
Откройте файл /etc/ssh/sshd_config, выполнив команду на сервере:
nano /etc/ssh/sshd_config
Найдите следующие строки, раскомментируйте их (уберите значок решетки # в начале строки) и поменяйте значения у параметров:
PubkeyAuthentication yes
PasswordAuthentication no
Image5
Перезапустите службу SSH.
Изменение стандартного порта
Порт 22 постоянно сканируется ботами. Его смена резко снижает количество подозрительных попыток входа.
Для этого в файле /etc/ssh/sshd_config необходимо поменять значение у параметра Port.
Откройте файл на сервере:
nano /etc/ssh/sshd_config
Раскомментируйте или добавьте строку с нестандартным портом из диапазона 1024-49151, например, 2242:
Port 2242
Image6
Перезапустите службу SSH.
Теперь при подключении к серверу будет нужно явно указывать новый порт. В этом случае команда для подключения будет выглядеть следующим образом:
ssh -p номер_порта имя_пользователя@IP_адрес_сервера
Например:
ssh -p 2242 root@89.169.44.30
Запрет на подключение от root-пользователя
Работа от имени root рискованна — одна ошибочная команда может вывести систему из строя. Вместо этого рекомендуется создать дополнительного пользователя с привилегиями sudo, а вход из-под root — отключить.
Для примера создадим нового пользователя с именем dev-user. Вы можете задать любое удобное имя.
adduser dev-user
Далее добавим его в группу sudo:
usermod -aG sudo dev-user
Перед тем как запрещать доступ пользователю root, убедитесь, что вы можете успешно подключиться к серверу под новым пользователем:
ssh -p 2242 dev-user@89.169.44.30
Теперь можно редактировать файл /etc/ssh/sshd_config. 
Откройте файл:
nano /etc/ssh/sshd_config
Поменяйте значение у параметра PermitRootLogin:
PermitRootLogin no
Перезапустите службу SSH.
Заключение
SSH — это краеугольный камень безопасного администрирования Linux-серверов. Ключевой минимум для защиты включает:
Переход на аутентификацию по SSH-ключам вместо паролей.
Перенос SSH-сервиса на нестандартный порт для ухода от фонового шума атак.
Блокировка прямого доступа для root и использование принципа наименьших привилегий.
Эти три шага эффективно отражают большинство автоматизированных атак и формируют прочный фундамент для безопасности вашего сервера. Дальнейшее усиление защиты может включать настройку Fail2ban, использование двухфакторной аутентификации или ограничение доступа по IP-адресам.

Как использовать SMTP-сервер Google

SMTP — simple mail transfer protocol — дословно переводится как «простой протокол передачи почты». Из названия понятно, что его используют для отправки электронной почты и доставки писем адресату. 
Что такое SMTP-сервер?
SMTP-сервер — это сервер, который отвечает за корректную работу протокола. Его главная задача — быть ретранслятором между отправителем и получателем. Она заключается в выполнении каждой из двух ключевых функций:
Проверка корректности конфигурации и выдача разрешения устройству, которое пытается отправить сообщение.
Отправка сообщения на указанный адрес и получение кода ответа.
На этом зона ответственности SMTP-сервера заканчивается, его функционал рассчитан только на отправку писем. За получение почты на стороне адресата отвечают протоколы POP3 и IMAP. 
Примерный пошаговый алгоритм отправки письма выглядит так:
Сервер отправителя получает необходимые данные — адреса отправителя и получателя и само сообщение, содержащее необходимые поля.
Сервер отправителя ищет адресата, определяя почтового провайдера по электронному адресу, и запрашивает его IP-адрес.
Сервер-отправитель получает ответ от сервера-получателя. 
Если со стороны получателя нет ответа, сервер ещё несколько раз пытается установить соединение. В случае, если ответа всё ещё нет — возвращает код ошибки.
Стандартный порт для работы SMTP — 25. Но помимо него также используются 465 и 587 порты для защищённого SSL-соединения и обязательной аутентификации соответственно. Отдельно стоит отметить, что некоторые провайдеры блокируют 25 порт, чтобы предотвратить спам-рассылки, уточняйте этот вопрос индивидуально. 
В качестве SMTP-сервера вы можете использовать облачные серверы практически в любой конфигурации. Однако если вы планируете запускать большие рассылки или вам критически важно, чтобы письма не были отмечены как спам, рекомендуем воспользоваться SMTP-сервером Google.
Плюсы использования SMTP-сервера Google
Стоимость. Один из самых очевидных плюсов — использование Google SMTP абсолютно бесплатно, достаточно иметь аккаунт в системе. 
Всё уже настроено. Администрирование сервера почты — довольно сложное занятие, которое потребует теоретических знаний сетевых протоколов, а также практического опыта настройки серверов. Используя стороннее решение, вы сэкономите на конфигурации сервера множество часов. 
Резервное копирование. Кроме того, вы не несёте ответственность за бесперебойность работы сервера — если что-то «упадёт» среди ночи, этим займутся специалисты Google. Они также обязаны делать резервное копирование отправленной и полученной почты, освобождая вас от головной боли с сохранением ценной и конфиденциальной информации. 
Индексация. Дополнительным плюсом хранения почты на серверах Google также является то, что индексация и поиск производятся с помощью вычислительных мощностей корпорации. При использовании одного и того же SMTP Gmail автоматически разместит письма в отправленных и полученных — вся почта будет отображаться в едином месте. 
Спам. Борьба со спамом — одна из самых больших проблем при создании собственного почтового сервера. Используя собственный SMTP-сервер, вы должны следить за тем, чтобы ваши письма не попадали в спам. При отправке письма через SMTP-сервер Google вы можете быть уверены, что оно придёт получателю так же, как и обычное письмо с почты gmail. Поскольку Google не использует стандартный 25 порт для отправки писем, вероятность, что провайдер пометит письмо как спам или вовсе заблокирует, снижается. 
Недостатки стороннего SMTP
Хранение на удалённом сервере. Один из самых распространённых страхов по поводу сторонних SMTP-серверов заключается в том, что вся ваша переписка находится под контролем Google. Однако конфиденциальность переписки и хранения почты на собственных серверах всё ещё под вопросом, если вы собираетесь общаться со среднестатистическими пользователями — ведь они вряд ли используют собственные SMTP-серверы.
Лимит. Google ограничивает количество писем в день до 100 штук. Этого вполне хватит, если вы тестируете механизм SMTP-отправок или ваш проект не рассчитан на большие объёмы исходящих писем.
Настройка Google SMTP 
Для настройки сервиса потребуется доступ к учётной записи экосистемы Google. В общем случае достаточно пары логин-пароль, но если у вас подключена двухфакторная аутентификация, что мы настоятельно рекомендуем сделать, вам нужно сгенерировать специальный пароль приложения на соответствующей странице.
Для работы почты вам понадобится следующий список настроек Google SMTP-сервера:
Сервер SMTP (сервер исходящей почты): smtp.google.com
Имя пользователя SMTP: полный адрес вашей электронной почты
Пароль SMTP: пароль вашей учётной записи Google или кодовое слово, которое вы указали при регистрации приложения.
Порт SMTP: 465
Требуется SMTP TLS/SSL?: да
Обратите внимание, что Google будет автоматически перезаписывать заголовок From любого письма, которое вы отправляете через SMTP-сервер, если оно не совпадает с вашим адресом по умолчанию. Так, если вы при отправки указали несуществующий адрес электронной почты, Google заменит его на ваш. Такое поведение является стандартным, но вы можете регулировать его в настройках почты. 
Почтовые клиенты
Кроме автоматизированной отправки писем с помощью SMTP-сервера Google вы также можете использовать данные для подключения к почтовым клиентам — например, Thunderbird или Outlook. Так вы сможете отправлять электронные письма не через браузер или стандартный клиент Google.  
Но обратите внимание, чтобы получать почту с вашего Google-аккаунта в другом клиенте, вам нужно использовать POP3 или IMAP. Параметры протоколов находятся в там же, где и все настройки почты Gmail в разделе «Переадресация и POP/IMAP»
Тестирование отправки
Для того, чтобы протестировать конфигурацию, которую мы привели для настройки, напишем простой PHP-скрипт. Почту будем отправлять с помощью пакета phpmailer, установим его через менеджер зависимостей Composer:
composer require phpmailer/phpmailer
Далее создадим файл index.php, в котором укажем настройки SMTP-сервера и попробуем отправить тестовое письмо. 
<?php
error_reporting(E_ALL); # выводим ошибки
// Подключаем phpmail                
require dirname(__FILE__) . '/vendor/autoload.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;
$mail = new PHPMailer(true);
// Указываем, что нужно использовать SMTP
$mail->isSMTP();
// В целях отладки включаем вывод результатов на страницу отправки
$mail->SMTPDebug = 2;
$mail->Debugoutput = 'html';
// Указываем доступы к SMTP
$mail->Host = 'smtp.gmail.com'; # хост
$mail->Port = 587; # порт
$mail->SMTPSecure = 'tls'; # шифрование
$mail->SMTPAuth = true; # авторизация
$mail->Username = "user@gmail.com"; # логин
$mail->Password = "62584jattjjtmxnpwf124"; # полученный пароль
// Получатели и отправители
$mail->setFrom('test-mail@timeweb.com', 'Тестовый отправитель Timeweb'); # от кого
$mail->addReplyTo('replyto@example.com', 'First Last'); # адрес для ответа
$mail->addAddress('mail@kulizh.ru', 'Nikita Kulizhnikov'); # кому
// Тема и содержание
$mail->Subject = 'Timweb: test SMTP Google'; # тема
$mail->msgHTML('<h1>Hello, Timeweb</h1>'); # содержание в формате HTML
$mail->AltBody = 'This is a plain-text message body'; # альтернативный текст, если не удастся использовать HTML
// Выводим результат
if (!$mail->send()) {
    echo "Mailer Error: " . $mail->ErrorInfo;
} else {
    echo "Message sent!";
}
Вы можете использовать такой же скрипт, указав свои данные для подключения, а также получателей и обратный адрес Reply-To. 
Теперь исполним PHP-скрипт через браузер, просто запустив страницу. Если всё указано верно, мы увидим подробный вывод результатов отправки письма. 
Если какие-то доступы мы указаны неверно, PHPMailer отобразит сообщение об ошибке.
Откроем почтовый клиент, посмотрим, пришло ли письмо. Всё в порядке, видим, что письмо получено. Также мы увидим его в списке отправленной почты в клиенте Gmail. 
Заключение
В этой статье мы рассмотрели преимущества использования SMTP-сервера Google. Среди них отсутствие расходов на настройку и обслуживание (услуга бесплатная), надёжное резервное копирование, а также гарантия непопадания в спам-листы.
Кроме того, в целях тестирования мы написали простой PHP-скрипт, на примере которого продемонстрировали работоспособность отправки.
В статье также упомянуты ограничения и минусы использования сторонних сервисов отправки почты. Если вы захотите настроить собственный сервер, воспользуйтесь облачными решениями Timeweb, наши специалисты помогут с выбором конфигурации, а также проконсультируют по поводу настройки PTR-записей.

Установка и настройка Redis для разных ОС

Redis — это система управления базами данных, которая хранит данные в формате «ключ-значение»: уникальному ключу в БД соответствует некоторое значение. Данные в этой базе данных хранятся в оперативной памяти, благодаря чему запросы обрабатываются быстро. 
Согласно рейтингу DB-Engines.com, Redis — это самая популярная СУБД «ключ-значение». Благодаря этому типу, архитектура базы и запросы к ней проще, чем в реляционных баз данных. Однако использовать привычный SQL на стандартном Redis не получится: придется работать с Lua-скриптами или устанавливать модифицированные версии, например RediSQL.
Redis лучше всего использовать в проектах, где нужна база данных с быстрым доступом к данным и простой схемой.
Чтобы вы могли комфортно использовать эту СУБД в своих проектах, мы подготовили материал по установке Redis на три операционные системы: на Windows, Ubuntu и CentOS. По завершении установки мы настроим Redis, после чего СУБД будет готова к работе.
Redis: установка на Windows
Есть два варианта установки Redis на Windows:
установка портированной версии;
установка в WSL или Docker.
В этом разделе мы разберем установку портированной версии. Если вы хотите установить в WSL, то:
руководство по установке и настройке WSL в Windows 10 вы найдете в материале «Как установить Node.js на Windows» в разделе «Установка WSL»;
инструкция по установке на Ubuntu описана чуть ниже в разделе «Установка на Ubuntu».
Портированная версия для Windows вышла довольно давно: в 2016 году. Она размещена на github и доступна для скачивания всем пользователями. Преимущества установки этой версии заключается в её простоте: для установки не потребуется дополнительная «прослойка» в виде Docker или WSL. Выбирайте порт для Windows, если не хотите усложнять процесс установки и вас устраивает 6-летняя версия.
Установка Redis на Windows
Шаг 1 — заходим в репозиторий на GitHub портированной версии по ссылке: https://github.com/microsoftarchive/redis. 
Шаг 2 — переходим на вкладку «Releases».
Шаг 3 — выбираем последний релиз.
Шаг 4 — скачиваем файл с расширением .msi. На изображении он выделен синим цветом:
Шаг 5 — после загрузки откройте файл. Начнется установка.
Шаг 6 — во время установки инсталлятор предложит вам добавить Redis в PATH. Если хотите использовать СУБД из командной строки, проставьте галочку напротив этого пункта.
Шаг 7 — во время выбора порта рекомендуется оставить стандартное значение 6379.
Шаг 8 — после установки необходимо перезагрузить компьютер.
После загрузки компьютера проверим работоспособность Redis. Для этого в командной строке выполняем команду redis-server. 
При её выполнении может возникнуть ошибка со следующим сообщением:
Проблема заключается в том, что Windows в автоматическом режиме после установки регистрирует службу, к которой привязывает порт 6379. Когда выполняется команда redis-server, исполнитель обращается к файлу конфигурации и использует порт по-умолчанию, т.е. 6379. Из-за этого возникает ошибка.
Чтобы её решить открываем командную строку и делаем следующее:
переходим в каталог Redis командой cd;
запускаем redis-cli.exe;
выключаем сервер командой shutdown;
выходим командой exit.
Вот набор команд для стандартного каталога:
После этих действий команда redis-server успешно выполнилась:
Настройки Redis описываются в двух файлах: redis.windows.conf и redis.windows-service.conf. 
Redis.windows-service.conf описывает настройки СУБД, запущенной в качестве службы. Этот формат подразумевает работу в фоновом режиме под управлением операционной системы (запуск при перезагрузке, перезапуск при сбоях и т.п).
Redis.windows.conf относится к использованию СУБД из командной строки с помощью redis-cli. Это же относится и к использованию СУБД в своих скриптах.
Настройка этих файлов приведет к изменению работы Redis. В нашем случае настроек минимальное количество: СУБД прослушивает любые подключения. Это не совсем безопасно, поэтому позволим подключение к Redis только с localhost. Для этого в файлах конфигурации находим задокументированную строку #bind 127.0.0.1 и удаляем решетку «#»:
Установка Redis: Ubuntu 22.04
Устанавливать Redis на Ubuntu мы будем из официального репозитория. Также, эта инструкция подойдет для установки Redis на Debian. 
Шаг 1 — в первую очередь обновим индексы пакетов apt:
sudo apt update
Шаг 2 — загружаем Redis:
sudo apt install redis-server -y
Проверить работоспособность можно командой sudo systemctl status redis:
Служба активна. 
Установка Redis: CentOS 7
Устанавливать Redis будем на CentOS 7. В первую очередь установим EPEL (Extra Packages for Enterprise Linux) — это пакет с дополнительными репозиториями, которые не включены в стандартную версию CentOS. Установим их:
sudo yum install epel-release
Теперь мы можем установить redis:
sudo yum install redis -y
Через несколько минут редис будет установлен на компьютер. Чтобы включить редис в автозагрузку, выполняем следующую команду:
sudo systemctl enable redis
Настройка Redis
Настройка Redis осуществляется через изменение конфигурационных файлов. Они для всех версий будут одинаковыми. Поэтому, для наглядной настройки, мы настроим Redis на операционной системе Ubuntu и удаленно подключимся к ней с Windows.
Для осуществления базовой настройки нам необходимо изменить 2 параметра: открыть удаленное подключение и установить пароль.
Шаг 1 — генерируем пароль:
openssl rand 25 | openssl base64 -A
Вывод:
/37DQhAt5MBq/34Lj24Ppn5LI/UZksAZJQ==
Злоумышленники могут перебирать до 150 тысяч паролей в секунду, поэтому важно выбрать надежный пароль. Копируем полученный результат и переходим к конфигурационному файлу.
Шаг 2 — открываем конфигурационный файл:
sudo nano /etc/redis/redis.conf
Шаг 3 — изменяем конфигурацию.
Найдем в конфигурационном файле строку «bind 127.0.0.1 ::1» и закомментируем её с помощью #. Не закрывая файл, найдем строку «protected-mode yes» и заменим её на «protected-mode no". В раздел «Security» после строки #requirepass foobared добавляем строку со сгенерированным паролем:
requirepass /37DQhAt5MBq/34Lj24Ppn5LI/UZksAZJQ==
Закрываем файл и сохраняем все изменения.
Шаг 4 — перезапускаем Redis, чтобы изменения вступили в силу:
sudo systemctl restart redis.service
Шаг 5 — с помощью netstat проверяем, какие сетевые интерфейсы прослушивает Redis:
sudo netstat -lnp | grep redis
Шаг 6 — подключаемся удаленно. Попробуем подключиться к базе данных из командной строки Windows:
redis-cli -h 192.168.43.37 -p 6379 -a /37DQhAt5MBq/34Lj24Ppn5LI/UZksAZJQ==
Пропингуем СУБД:
   
192.168.43.37:6379> ping
PONG
И вставим кортеж:
192.168.43.37:6379> set key test
OK
192.168.43.37:6379> get key
"test"
Redis как DBaaS
DBaaS (database as a service) — это база данных, размещенная в облаке. Этот сервис похож на аренду сервера, только вместо виртуальной машины вы получаете базу данных. Такой вариант обладает рядом преимуществ:
меньшее количество административных хлопот: не нужно обновлять СУБД и обслуживать оборудование;
легкое масштабирование базы данных: если для вашего проекта потребовалась более производительная БД, то это легко сделать в панели управления;
быстрый старт: СУБД будет установлена на старте;
бесперебойная работа.
Заключение
В Timeweb.cloud есть услуга «Облачные базы данных» — уже готовое и настроенное решение. Если вы не хотите отягощать себя административными манипуляциями, то вы можете арендовать базу данных на Redis у Timeweb Cloud. Помимо Redis, Timeweb Cloud может предложить в качестве СУБД MySQL, PostgreSQL и, конечно же, MongoDB.